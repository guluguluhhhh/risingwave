# Test for GAP FILL with EOWC (Event-time Oriented Window Computing) syntax.
# This requires watermark definition and EMIT ON WINDOW CLOSE.

statement ok
CREATE TABLE gap_table (
    device_id VARCHAR,
    ts TIMESTAMP,
    value DOUBLE,
    PRIMARY KEY (ts),
    WATERMARK FOR ts AS ts - INTERVAL '5' SECOND
) APPEND ONLY;

statement ok
INSERT INTO gap_table VALUES
    ('device1', '2024-05-21 10:00:00', 10.0),
    ('device1', '2024-05-21 10:02:00', 12.0),
    ('device1', '2024-05-21 10:05:00', 15.0);

# Use EOWC syntax with EMIT ON WINDOW CLOSE
statement ok
CREATE MATERIALIZED VIEW gap_filled AS
SELECT device_id, ts, value
FROM GAP_FILL(gap_table, ts, INTERVAL '1' MINUTE)
EMIT ON WINDOW CLOSE;

# Insert some more data with later timestamps to trigger watermark advancement
statement ok
INSERT INTO gap_table VALUES
    ('device1', '2024-05-21 10:08:00', 21.0);

# Wait longer for processing and watermark advancement
sleep 6s

# Check the result - GAP_FILL uses LOCF (Last Observation Carried Forward) by default
query TTR
SELECT device_id, ts, value FROM gap_filled ORDER BY device_id, ts;
----
device1 2024-05-21 10:00:00 10
device1 2024-05-21 10:01:00 10
device1 2024-05-21 10:02:00 12
device1 2024-05-21 10:03:00 12
device1 2024-05-21 10:04:00 12
device1 2024-05-21 10:05:00 15

statement ok
DROP MATERIALIZED VIEW gap_filled;

# Test with custom fill strategies - LOCF
statement ok
CREATE MATERIALIZED VIEW gap_filled_locf AS
SELECT device_id, ts, value
FROM GAP_FILL(gap_table, ts, INTERVAL '1' MINUTE, LOCF(value))
EMIT ON WINDOW CLOSE;

# Insert more data to trigger watermark
statement ok
INSERT INTO gap_table VALUES
    ('device1', '2024-05-21 10:10:00', 25.0);

# Wait for watermark advancement
sleep 6s

# Should have same result with explicit LOCF strategy
query TTR
SELECT device_id, ts, value FROM gap_filled_locf ORDER BY device_id, ts;
----
device1 2024-05-21 10:00:00 10
device1 2024-05-21 10:01:00 10
device1 2024-05-21 10:02:00 12
device1 2024-05-21 10:03:00 12
device1 2024-05-21 10:04:00 12
device1 2024-05-21 10:05:00 15
device1 2024-05-21 10:06:00 15
device1 2024-05-21 10:07:00 15
device1 2024-05-21 10:08:00 21

statement ok
DROP MATERIALIZED VIEW gap_filled_locf;

# Test with INTERPOLATE strategy
statement ok
CREATE MATERIALIZED VIEW gap_filled_interpolate AS
SELECT device_id, ts, value
FROM GAP_FILL(gap_table, ts, INTERVAL '1' MINUTE, INTERPOLATE(value))
EMIT ON WINDOW CLOSE;

# Wait for watermark advancement (data already inserted)
sleep 6s

# Check interpolated values
query TTR
SELECT device_id, ts, value FROM gap_filled_interpolate ORDER BY device_id, ts;
----
device1 2024-05-21 10:00:00 10
device1 2024-05-21 10:01:00 11
device1 2024-05-21 10:02:00 12
device1 2024-05-21 10:03:00 13
device1 2024-05-21 10:04:00 14
device1 2024-05-21 10:05:00 15
device1 2024-05-21 10:06:00 17
device1 2024-05-21 10:07:00 19
device1 2024-05-21 10:08:00 21

statement ok
DROP MATERIALIZED VIEW gap_filled_interpolate;

statement ok
DROP TABLE gap_table;

# Test mixed multi-column fill strategies with EOWC
statement ok
CREATE TABLE gap_multi_column_table (
    device_id VARCHAR,
    ts TIMESTAMP,
    temperature DOUBLE,
    pressure DOUBLE,
    status VARCHAR,
    PRIMARY KEY (ts),
    WATERMARK FOR ts AS ts - INTERVAL '5' SECOND
) APPEND ONLY;

statement ok
INSERT INTO gap_multi_column_table VALUES
    ('sensor1', '2024-05-21 10:00:00', 20.0, 100.0, 'active'),
    ('sensor1', '2024-05-21 10:04:00', 24.0, 120.0, 'inactive');

# Create MV with mixed strategies:
# - temperature: INTERPOLATE (linear interpolation)
# - pressure: LOCF (last observation carried forward)
# - status: KEEPNULL (keep as NULL for filled rows)
statement ok
CREATE MATERIALIZED VIEW gap_filled_mixed AS
SELECT device_id, ts, temperature, pressure, status
FROM GAP_FILL(gap_multi_column_table, ts, INTERVAL '1' MINUTE,
              INTERPOLATE(temperature), LOCF(pressure), KEEPNULL(status))
EMIT ON WINDOW CLOSE;

# Insert data with later timestamp to trigger watermark advancement
statement ok
INSERT INTO gap_multi_column_table VALUES
    ('sensor1', '2024-05-21 10:10:00', 30.0, 150.0, 'active');

# Wait for watermark advancement
sleep 6s

# Check result - temperature interpolated, pressure LOCF, status NULL
query TTRRR
SELECT device_id, ts, temperature, pressure, status FROM gap_filled_mixed ORDER BY device_id, ts;
----
sensor1 2024-05-21 10:00:00 20 100 active
sensor1 2024-05-21 10:01:00 21 100 NULL
sensor1 2024-05-21 10:02:00 22 100 NULL
sensor1 2024-05-21 10:03:00 23 100 NULL
sensor1 2024-05-21 10:04:00 24 120 inactive

# Cleanup
statement ok
DROP MATERIALIZED VIEW gap_filled_mixed;

statement ok
DROP TABLE gap_multi_column_table;
